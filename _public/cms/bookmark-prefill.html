<!DOCTYPE html>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Bookmark Prefill</title>
<link rel="manifest" href="/cms/bookmark-prefill-manifest.json">
<style>
  html {
    font-family: sans-serif;
    padding: 1rem;
  }

  label {
    display: flex;
    flex-direction: column;
  }

  input {
    padding: 0.5rem;
  }

  a {
    display: inline-block;
    margin-top: 1rem;
    border: 1px solid grey;
    border-radius: 4px;
    padding: 0.5rem;
    text-decoration: none;
  }
</style>

<h1>Bookmark Prefill</h1>

<div>
  <label>
    <div>Title:</div>
    <input type="text" />
    <p data-title></p>
  </label>
</div>
<br />
<div>
  <label>
    <div>Url:</div>
    <input type="url" />
    <p data-url></p>
  </label>
</div>

<script>
  const aElement = document.createElement('a')
  const titleInput = document.querySelector('input[type="text"]')
  const titleOutput = document.querySelector('[data-title]')
  const urlInput = document.querySelector('input[type="url"]')
  const urlOutput = document.querySelector('[data-url]')
  const queryString = location.search.replace('?', '')
  const pairs = queryString
    .split('&')
      .map(part => part
        .split('=')
      )
  const titlePair = pairs.find(([key]) => key === 'title')
  const urlPair = pairs.find(([key]) => key === 'text')

  document.body.appendChild(aElement)
  aElement.innerText = 'Save as bookmark'

  function updateLink(element) {
    return function (event) {
      element.innerText = event.target.value
      aElement.href = `/cms/#/collections/bookmarks/new?url=${encodeURIComponent(urlOutput.innerText)}&title=${encodeURIComponent(titleOutput.innerText)}`
    }
  }

  titleInput.addEventListener('input', updateLink(titleOutput))
  urlInput.addEventListener('input', updateLink(urlOutput))

  urlPair && urlPair[1] && (urlInput.value = decodeURIComponent(urlPair[1]))
  aElement.href = `/cms/#/collections/bookmarks/new?url=${urlPair[1]}`
  titlePair && titlePair[1] && (titleInput.value = decodeURIComponent(titlePair[1]).replace(/\+/g, ' '))

  if (titlePair && titlePair[1]) {
    aElement.href = `${aElement.href}&title=${titlePair[1]}`
  }

  titleOutput.innerHTML = titleInput.value
  urlOutput.innerHTML = urlInput.value

</script>

<script type="module">
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js');
    });
  }
</script>
